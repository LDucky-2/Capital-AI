<?php
include 'auth_session.php';
checkLogin();
include 'Database.php';

<<<<<<< Updated upstream:My_Stocks.html
    <div class="navbar">
        <ul>
            <li><a href="Audits.html">Audit Reports</a></li>
            <li><a href="Company_Database.html">Company Database</a></li>
            <li><a href="Employee_Database.html">Employee Database</a></li>
            <li><a href="Frauds.html">Fraud Alerts</a></li>
            <li><a href="Investor_Database.html">Investor Database</a></li>
            <li><a href="Logs.html">All Logs</a></li>
            <li><a href="My_Company.html">My Company</a></li>
            <li><a href="My_Institution.html">My Institution</a></li>
            <li><a href="My_Stocks.html" class="active">My Stocks</a></li>
            <li><a href="Predictions.html">Stock Prediction</a></li>
            <li><a href="Stock_Transactions_and_Trades.html">Stock Transactions and Trades Database</a></li>
            <li><a href="Stocks.html">All Stocks</a></li>
            <li><a href="Institution_Database.html">Institutions</a></li>
            <!-- <li><a href="Employee_Database.html">Employee Database</a></li> -->
            <!-- <li><a href="Employee_Database.html">Employee Database</a></li>  -->
            <!-- <li><a href="Log_in.html">Log In Page</a></li> -->
        </ul>
    </div>
=======
$user_id = $_SESSION['User_ID'];
$role = $_SESSION['Permission'];
$stocks_data = [];
$mode = "";
>>>>>>> Stashed changes:My_Stocks.php

if ($role === 'Company') {
    $mode = "issued";
    $sql = "SELECT Stock_ID, Total_Shares, Current_Price FROM Stock_T WHERE Company_User_ID = '$user_id'";
    $result = $conn->query($sql);
} elseif ($role === 'Investor') {
    $mode = "portfolio";
    // Aggregate portfolio
    $sql = "
        SELECT 
            t.Stock_ID,
            s.Current_Price,
            c_user.Name as Company_Name,
            SUM(CASE WHEN t.Transaction_Type = 'buy' THEN t.Share_Amount ELSE 0 END) - 
            SUM(CASE WHEN t.Transaction_Type = 'sell' THEN t.Share_Amount ELSE 0 END) as Net_Shares
        FROM Stock_Transactions_T t
        JOIN Stock_T s ON t.Stock_ID = s.Stock_ID
        JOIN Company_T c ON s.Company_User_ID = c.Company_User_ID
        JOIN User_T c_user ON c.Company_User_ID = c_user.User_ID
        WHERE t.Investor_User_ID = '$user_id'
        GROUP BY t.Stock_ID, s.Current_Price, c_user.Name
        HAVING Net_Shares > 0
    ";
    $result = $conn->query($sql);
} else {
    $mode = "none";
    $result = null;
}
?>

<?php include 'includes/header.php'; ?>
<?php include 'includes/sidebar.php'; ?>

<div class="page-header">
    <h2>My Portfolio</h2>
</div>

<?php
if (isset($_GET['msg'])) {
    if ($_GET['msg'] == 'sold') echo "<div class='alert'>Stock sold successfully!</div>";
}
?>

<div class="data-table-scroll-wrapper">
    <table class="data-table">
        <thead>
            <tr>
                <th>Stock ID</th>
                <?php if ($mode == 'portfolio'): ?>
                <th>Company Name</th>
                <th>Net Shares Owned</th>
                <?php elseif ($mode == 'issued'): ?>
                <th>Total Shares Issued</th>
                <?php endif; ?>
                <th>Current Price</th>
                <th>Total Value</th>
                <?php if ($mode == 'portfolio') echo "<th>Action</th>"; ?>
            </tr>
        </thead>
        <tbody>
            <?php
            if ($result && $result->num_rows > 0) {
                while($row = $result->fetch_assoc()) {
                    echo "<tr>";
                    echo "<td>" . htmlspecialchars($row['Stock_ID']) . "</td>";
                    
                    if ($mode == 'portfolio') {
                         echo "<td>" . htmlspecialchars($row['Company_Name']) . "</td>";
                         echo "<td>" . htmlspecialchars($row['Net_Shares']) . "</td>";
                         echo "<td>$" . htmlspecialchars($row['Current_Price']) . "</td>";
                         echo "<td>$" . number_format($row['Net_Shares'] * $row['Current_Price'], 2) . "</td>";
                         
                         // Sell Form
                         echo "<td>";
                         echo "<form action='stock_action.php' method='POST' style='display:inline-flex; gap:5px;'>";
                         echo "<input type='hidden' name='stock_id' value='" . $row['Stock_ID'] . "'>";
                         echo "<input type='hidden' name='action' value='sell'>";
                         echo "<input type='number' name='amount' placeholder='Qty' min='1' max='" . $row['Net_Shares'] . "' style='width:60px; padding:5px; margin:0; background:#111; border:1px solid #333; color:#fff;' required>";
                         echo "<button type='submit' class='btn-action' style='background-color:#c0392b; color:white; border-color:#c0392b;'>SELL</button>";
                         echo "</form>";
                         echo "</td>";
                         
                    } elseif ($mode == 'issued') {
                         echo "<td>" . htmlspecialchars($row['Total_Shares']) . "</td>";
                         echo "<td>$" . htmlspecialchars($row['Current_Price']) . "</td>";
                         echo "<td>$" . number_format($row['Total_Shares'] * $row['Current_Price'], 2) . "</td>";
                    }
                    
                    echo "</tr>";
                }
            } else {
                echo "<tr><td colspan='6' style='text-align:center;'>No active stocks in portfolio.</td></tr>";
            }
            ?>
        </tbody>
    </table>
</div>

<?php include 'includes/footer.php'; ?>