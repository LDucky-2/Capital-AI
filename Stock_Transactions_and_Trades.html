<?php
include 'auth_session.php';
checkLogin();
include 'Database.php';

<<<<<<< Updated upstream:Stock_Transactions_and_Trades.html
    <div class="navbar">
        <ul>
            <li><a href="Audits.html">Audit Reports</a></li>
            <li><a href="Company_Database.html">Company Database</a></li>
            <li><a href="Employee_Database.html">Employee Database</a></li>
            <li><a href="Frauds.html">Fraud Alerts</a></li>
            <li><a href="Investor_Database.html">Investor Database</a></li>
            <li><a href="Logs.html">All Logs</a></li>
            <li><a href="My_Company.html">My Company</a></li>
            <li><a href="My_Institution.html">My Institution</a></li>
            <li><a href="My_Stocks.html">My Stocks</a></li>
            <li><a href="Predictions.html">Stock Prediction</a></li>
            <li><a href="Stock_Transactions_and_Trades.html" class="active">Stock Transactions and Trades Database</a></li>
            <li><a href="Stocks.html">All Stocks</a></li>
            <li><a href="Institution_Database.html">Institutions</a></li>
            <!-- <li><a href="Employee_Database.html">Employee Database</a></li> -->
            <!-- <li><a href="Employee_Database.html">Employee Database</a></li>  -->
            <!-- <li><a href="Log_in.html">Log In Page</a></li> -->
        </ul>
    </div>
=======
// Fetch Stock Transactions (Investors buying/selling stocks)
$sql_stock_trans = "
    SELECT 
        t.Transaction_ID,
        t.Stock_ID,
        u.Name as Investor_Name,
        t.Share_Amount,
        t.Transaction_Type
    FROM Stock_Transactions_T t
    JOIN User_T u ON t.Investor_User_ID = u.User_ID";
>>>>>>> Stashed changes:Stock_Transactions_and_Trades.php

// Filter for Investor Role
if (hasRole('Investor')) {
    $investor_id = $_SESSION['User_ID'];
    $sql_stock_trans .= " WHERE t.Investor_User_ID = '$investor_id'";
}

$sql_stock_trans .= " ORDER BY t.Transaction_ID DESC";

$Stock_Transactions = $conn->query($sql_stock_trans);

// Fetch Institution Trades
// Trade_T: Buyer_Institution_ID, Seller_Institution_ID
$sql_trades = "
    SELECT 
        t.Trade_ID,
        b_user.Name as Buyer_Name,
        s_user.Name as Seller_Name,
        t.Asset_Type,
        t.Trade_Details
    FROM Trade_T t
    JOIN User_T b_user ON t.Buyer_Institution_ID = b_user.User_ID
    JOIN User_T s_user ON t.Seller_Institution_ID = s_user.User_ID
    ORDER BY t.Trade_ID DESC
";
$Trades = $conn->query($sql_trades);
?>

<?php include 'includes/header.php'; ?>
<?php include 'includes/sidebar.php'; ?>

<div class="page-header">
    <h2>Transactions & Trades</h2>
</div>

<div class="content-section" style="margin-bottom: 2rem;">
    <h3 class="section-title">Stock Transactions (Investors)</h3>
    <div class="data-table-scroll-wrapper">
        <table class="data-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Stock ID</th>
                    <th>Investor</th>
                    <th>Shares</th>
                    <th>Type</th>
                </tr>
            </thead>
            <tbody>
                <?php
                if ($Stock_Transactions && $Stock_Transactions->num_rows > 0) {
                    while($row = $Stock_Transactions->fetch_assoc()) {
                        $type_class = ($row['Transaction_Type'] == 'buy') ? 'text-green-500' : 'text-red-500'; // Add these utility classes later or inline
                        $color = ($row['Transaction_Type'] == 'buy') ? '#10b981' : '#ef4444';
                        
                        echo "<tr>";
                        echo "<td>" . htmlspecialchars($row['Transaction_ID']) . "</td>";
                        echo "<td>" . htmlspecialchars($row['Stock_ID']) . "</td>";
                        echo "<td>" . htmlspecialchars($row['Investor_Name']) . "</td>";
                        echo "<td>" . htmlspecialchars($row['Share_Amount']) . "</td>";
                        echo "<td style='color:$color; font-weight:bold; text-transform:uppercase;'>" . htmlspecialchars($row['Transaction_Type']) . "</td>";
                        echo "</tr>";
                    }
                } else {
                    echo "<tr><td colspan='5'>No stock transactions found.</td></tr>";
                }
                ?>
            </tbody>
        </table>
    </div>
</div>

<div class="content-section">
    <h3 class="section-title">Institutional Trades</h3>
    <div class="data-table-scroll-wrapper">
        <table class="data-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Buyer</th>
                    <th>Seller</th>
                    <th>Asset</th>
                    <th>Details</th>
                </tr>
            </thead>
            <tbody>
                <?php
                if ($Trades && $Trades->num_rows > 0) {
                    while($row = $Trades->fetch_assoc()) {
                        echo "<tr>";
                        echo "<td>" . htmlspecialchars($row['Trade_ID']) . "</td>";
                        echo "<td>" . htmlspecialchars($row['Buyer_Name']) . "</td>";
                        echo "<td>" . htmlspecialchars($row['Seller_Name']) . "</td>";
                        echo "<td>" . htmlspecialchars($row['Asset_Type']) . "</td>";
                        echo "<td>" . htmlspecialchars($row['Trade_Details']) . "</td>";
                        echo "</tr>";
                    }
                } else {
                    echo "<tr><td colspan='5'>No institutional trades found.</td></tr>";
                }
                ?>
            </tbody>
        </table>
    </div>
</div>

<?php include 'includes/footer.php'; ?>